<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Alumni Directory</title>
<style>
:root{--brand:#e8640a;--ink:#0f172a;--muted:#64748b;--bg:#f6f7f9;--card:#fff;--r:16px}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui}
.wrap{max-width:1200px;margin:0 auto;padding:20px clamp(12px,4vw,24px)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid #eef2f7;border-radius:var(--r);box-shadow:0 2px 10px rgba(15,23,42,.06)}
.pad{padding:16px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
input,select{padding:10px;border:1px solid #e2e8f0;border-radius:10px;min-height:40px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.card.profile{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:start}
.avatar{width:64px;height:64px;border-radius:14px;background:#fff;border:1px solid #e2e8f0;display:grid;place-items:center;font-weight:700}
.name{font-weight:700}.meta{color:#64748b;font-size:13px}
.links a{margin-right:10px;font-size:13px;color:var(--brand);text-decoration:none}
.links a:hover{text-decoration:underline}
@media(max-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.grid{grid-template-columns:1fr}}
</style>
</head><body>
<div class="wrap">
  <header class="header">
    <h1>Alumni Directory</h1>
    <a href="index.html" style="color:var(--brand);text-decoration:none">← Back to main page</a>
  </header>

  <section class="card pad">
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search name, city, profession…">
      <select id="year"><option value="">Year</option></select>
      <select id="country"><option value="">Country</option></select>
    </div>
    <div id="status" class="meta">Loading…</div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </section>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycby88hNEmXqnZ5D6T4LDUL96elLWI-MWyJruMXHccmN4q2VP8cRotIkUA0bpBIE6rj3m/exec";

const grid = document.getElementById('grid');
const statusEl = document.getElementById('status');
const q = document.getElementById('q');
const year = document.getElementById('year');
const country = document.getElementById('country');

function initials(a,b){return ((a||"")+" "+(b||"")).trim().split(/\s+/).slice(0,2).map(x=>x[0]||"").join("").toUpperCase()||"OR";}
function card(p){
  // Handle photo URL - check both photo_url and photo_url fields
  const photoUrl = p.photo_url || p['photo url'] || '';
  const img = photoUrl ? 
    `<img src="${photoUrl}" alt="${p.first_name} ${p.last_name}" class="avatar" style="object-fit:cover" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';">
     <div class="avatar" style="display:none">${initials(p.first_name,p.last_name)}</div>` :
    `<div class="avatar">${initials(p.first_name,p.last_name)}</div>`;
    
  const meta = [
    [p.city, p.country].filter(Boolean).join(", "),
    p.graduating_year ? `Class of ${p.graduating_year}` : "",
    p.profession
  ].filter(Boolean).join(" • ");
  
  const soc = [
    p.instagram && p.instagram.startsWith('http') && `<a href="${p.instagram}" target="_blank" rel="noopener">IG</a>`,
    p.facebook && p.facebook.startsWith('http') && `<a href="${p.facebook}" target="_blank" rel="noopener">FB</a>`,
    p.linkedin && p.linkedin.startsWith('http') && `<a href="${p.linkedin}" target="_blank" rel="noopener">IN</a>`,
    p.snapchat && p.snapchat.startsWith('http') && `<a href="${p.snapchat}" target="_blank" rel="noopener">SC</a>`
  ].filter(Boolean).join("");
  
  const name = [p.first_name, p.last_name].filter(Boolean).join(" ") || "Alumni Member";
  const joinDate = p.timestamp ? new Date(p.timestamp).toLocaleDateString() : '';
  
  return `<article class="card pad profile">
    ${img}
    <div>
      <div class="name">${name}</div>
      <div class="meta">${meta}</div>
      ${soc ? `<div class="links">${soc}</div>` : ''}
      ${joinDate ? `<div class="meta" style="font-size: 11px; margin-top: 4px;">Joined ${joinDate}</div>` : ''}
    </div>
  </article>`;
}

function render(list){
  grid.innerHTML = list.map(card).join("") || "<p class='meta'>No profiles found.</p>";
  statusEl.textContent = `${list.length} profile${list.length===1?"":"s"}`;
}

function applyFilters(all){
  const term = (q.value||"").toLowerCase();
  const y = year.value||""; const c = (country.value||"").toLowerCase();
  return all.filter(p=>{
    if (y && String(p.graduating_year||"") !== y) return false;
    if (c && String(p.country||"").toLowerCase() !== c) return false;
    if (!term) return true;
    const hay = [p.first_name,p.last_name,p.city,p.country,p.profession].join(" ").toLowerCase();
    return hay.includes(term);
  });
}

function dedupe(rows){
  const seen=new Set(), out=[];
  for(const r of rows){
    const k = (r.email||r.whatsapp)
      ? `${r.email||''}|${r.whatsapp||''}`
      : `${(r.first_name||'').trim().toLowerCase()} ${(r.last_name||'').trim().toLowerCase()}|${(r.city||'').trim().toLowerCase()}`;
    if(seen.has(k)) continue; seen.add(k); out.push(r);
  }
  out.sort((a,b)=>{
    const la=(a.last_name||'').localeCompare(b.last_name||'',undefined,{sensitivity:'base'});
    return la!==0 ? la : (a.first_name||'').localeCompare(b.first_name||'',undefined,{sensitivity:'base'});
  });
  return out;
}

/* ---- Loaders ---- */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},12000);
    function cleanup(){clearTimeout(t);delete window[cb];try{s.remove();}catch(_){}} 
    window[cb]=(data)=>{cleanup();resolve(data);};
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&t='+Date.now();
    s.async=true;s.onerror=()=>{cleanup();reject(new Error('JSONP onerror'));};
    document.head.appendChild(s);
  });
}
async function fetchViaProxy(url){
  const prox='https://api.allorigins.win/raw?url='+encodeURIComponent(url);
  const r=await fetch(prox,{cache:'no-store'}); if(!r.ok) throw new Error('Proxy HTTP '+r.status);
  return r.json();
}

async function load(){
  try{
    statusEl.textContent='Loading alumni profiles...';
    let data;
    let method = 'unknown';
    
    // Try direct fetch first
    try {
      console.log('Attempting direct fetch...');
      const response = await fetch(ENDPOINT + '?list=1&t=' + Date.now(), {
        method: 'GET',
        cache: 'no-store'
      });
      
      if (response.ok) {
        data = await response.json();
        method = 'direct';
        console.log('Direct fetch successful:', data);
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (directError) {
      console.log('Direct fetch failed:', directError.message);
      
      // Try JSONP
      try {
        console.log('Attempting JSONP...');
        data = await jsonp(ENDPOINT+'?list=1');
        method = 'jsonp';
        console.log('JSONP successful:', data);
      } catch (jsonpError) {
        console.log('JSONP failed:', jsonpError.message);
        
        // Try proxy as last resort
        console.log('Attempting proxy...');
        data = await fetchViaProxy(ENDPOINT+'?list=1');
        method = 'proxy';
        console.log('Proxy successful:', data);
      }
    }

    if (!data || !data.ok) {
      throw new Error(data?.error || 'Invalid response from server');
    }

    const rows = dedupe(Array.isArray(data.rows) ? data.rows : [])
      .filter(r => (r.first_name || r.last_name || r.email || r.whatsapp));

    console.log(`Loaded ${rows.length} alumni profiles via ${method}`);

    // Populate filter dropdowns
    const years = [...new Set(rows.map(r => r.graduating_year).filter(Boolean))].sort();
    year.innerHTML = '<option value="">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
    
    const countries = [...new Set(rows.map(r => r.country).filter(Boolean))].sort();
    country.innerHTML = '<option value="">All Countries</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');

    // Set up filtering
    const state = { all: rows };
    function update() { 
      const filtered = applyFilters(state.all);
      render(filtered);
    }
    
    q.addEventListener('input', update);
    year.addEventListener('change', update);
    country.addEventListener('change', update);
    
    // Initial render
    update();
    
    // Show load method in status for debugging
    if (rows.length === 0) {
      statusEl.textContent = `No profiles found (loaded via ${method})`;
    }

  } catch(e) {
    console.error('Load error:', e);
    statusEl.textContent = `Load failed: ${e.message}`;
    grid.innerHTML = `
      <div class='meta' style='grid-column: 1/-1; text-align: center; padding: 40px;'>
        <p><strong>Could not load alumni directory</strong></p>
        <p>Error: ${e.message}</p>
        <p><button onclick='location.reload()' style='padding: 8px 16px; margin-top: 10px;'>Try Again</button></p>
      </div>
    `;
  }
}
load();
if (localStorage.getItem("justJoined")){ localStorage.removeItem("justJoined"); q.focus(); }
</script>
</body></html>
